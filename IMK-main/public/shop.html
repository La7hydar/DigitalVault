<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DigitalVault | Store</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Space Grotesk', sans-serif; background-color: #020617; color: #f8fafc; }
        .glass { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .active-tab { color: #22d3ee; border-bottom: 2px solid #22d3ee; }
        input, textarea, select { background: rgba(255,255,255,0.05) !important; border: 1px solid rgba(255,255,255,0.1) !important; color: white !important; outline: none; }
        .card-hover:hover { transform: translateY(-5px); transition: 0.3s; border-color: #22d3ee; }
        .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    </style>
</head>
<body class="pb-20">
    
    <nav class="glass sticky top-0 z-40 mb-8">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <button onclick="logout()" class="text-xs font-bold text-red-500 hover:text-white transition flex items-center gap-1 cursor-pointer">
                <span>←</span> LOGOUT
            </button>
            <div class="flex gap-6">
                <button onclick="showPage('store')" id="tabStore" class="text-xs font-bold active-tab pb-1">STORE</button>
                <a href="faq.html" class="text-xs font-bold text-slate-400 pb-1 hover:text-white">FAQ</a>
                <button onclick="showPage('assets')" id="tabAssets" class="text-xs font-bold text-slate-400 pb-1">RIWAYAT</button>
                <a href="about.html" class="text-xs font-bold text-slate-400 pb-1 hover:text-white">ABOUT</a>
            </div>
        </div>
    </nav>

    <div id="pageStore" class="container mx-auto px-6">
        <div class="flex flex-wrap gap-2 mb-8">
            <button onclick="filter('all')" class="glass px-4 py-2 rounded-full text-xs hover:bg-white/10 transition">Semua</button>
            <button onclick="filter('jasa_it')" class="glass px-4 py-2 rounded-full text-xs text-blue-400 hover:bg-white/10 transition">Jasa IT</button>
            <button onclick="filter('design')" class="glass px-4 py-2 rounded-full text-xs text-pink-400 hover:bg-white/10 transition">Desain</button>
            <button onclick="filter('license')" class="glass px-4 py-2 rounded-full text-xs text-green-400 hover:bg-white/10 transition">License</button>
        </div>
        
        <div id="productGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-6"></div>
    </div>

    <div id="pageAssets" class="container mx-auto px-6 hidden">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-cyan-400 uppercase tracking-tighter">Riwayat Pesanan</h2>
            <button onclick="clearAllHistory()" class="text-[10px] text-red-500 font-bold border border-red-500/20 px-3 py-1 rounded-lg hover:bg-red-500/10">BERSIHKAN</button>
        </div>
        <div class="glass rounded-3xl p-6 text-white overflow-hidden">
            <table class="w-full text-left text-xs">
                <thead class="text-slate-500 border-b border-white/5 uppercase">
                    <tr><th class="pb-4 pl-2">Layanan</th><th class="pb-4">Status</th><th class="pb-4 text-right pr-2">Aksi</th></tr>
                </thead>
                <tbody id="orderList" class="divide-y divide-white/5"></tbody>
            </table>
        </div>
    </div>

    <div id="modalOrder" class="fixed inset-0 z-50 hidden bg-black/95 backdrop-blur-md overflow-y-auto p-4 flex items-center justify-center">
        <div class="w-full max-w-md glass p-8 rounded-[40px] border border-cyan-500/20 relative">
            <button onclick="closeOrderModal()" class="absolute top-4 right-6 text-slate-500 text-xl hover:text-white">&times;</button>
            
            <div class="text-center mb-6">
                <img id="detailImg" src="" class="w-full h-40 object-cover rounded-2xl border border-white/10 mb-4 shadow-2xl">
                <h2 id="detailTitle" class="text-2xl font-bold text-cyan-400 mb-1 uppercase tracking-tighter"></h2>
                <span id="detailCat" class="inline-block px-3 py-1 rounded-full bg-cyan-500/10 text-cyan-400 text-[9px] font-bold mb-4 uppercase tracking-widest"></span>
                <p id="detailDesc" class="text-slate-300 text-xs leading-relaxed px-2"></p>
            </div>

            <div class="space-y-4 border-t border-white/10 pt-6">
                <div>
                    <label class="text-[10px] font-bold text-slate-500 uppercase ml-2 mb-2 block">Opsi Layanan</label>
                    <div class="flex gap-2">
                        <input type="number" id="orderQty" value="1" min="1" class="w-20 p-3 rounded-xl text-center">
                        <select id="orderTime" class="flex-grow p-3 rounded-xl cursor-pointer">
                            <option>Reguler (5-7 Hari)</option>
                            <option>Fast Track (2-3 Hari)</option>
                            <option>Express (24 Jam)</option>
                        </select>
                    </div>
                </div>
                
                <div>
                    <label class="text-[10px] font-bold text-slate-500 uppercase ml-2 mb-2 block">Catatan / Brief</label>
                    <textarea id="orderNotes" rows="3" placeholder="Jelaskan kebutuhan Anda..." class="w-full p-4 rounded-xl"></textarea>
                </div>

                <button onclick="confirmPurchase()" class="w-full bg-cyan-500 text-slate-900 font-bold py-4 rounded-xl hover:bg-white transition uppercase shadow-lg shadow-cyan-500/20 mt-2">
                    BELI SEKARANG
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. SETTING SERVER ---
        const API_URL = 'http://localhost:3000/api'; // Menggunakan IP 127.0.0.1 agar lebih stabil

        // --- 2. CEK LOGIN ---
        if(!localStorage.getItem('token')) {
            window.location.href = 'index.html';
        }

        // --- 3. DATA PRODUK (Pastikan URL gambar valid) ---
        const products = [
            { id: 1, cat: 'jasa_it', name: "Web Landing Page", price: "1.5jt", img: "https://images.unsplash.com/photo-1460925895917-afdab827c52f?w=400", desc: "Landing page modern responsif." },
            { id: 2, cat: 'jasa_it', name: "E-Commerce System", price: "5jt", img: "https://images.unsplash.com/photo-1557821552-17105176677c?w=400", desc: "Toko online lengkap payment gateway." },
            { id: 3, cat: 'jasa_it', name: "Mobile App", price: "8jt", img: "https://images.unsplash.com/photo-1512941937669-90a1b58e7e9c?w=400", desc: "Aplikasi Android/iOS Flutter." },
            { id: 4, cat: 'jasa_it', name: "Python Automation", price: "800rb", img: "https://images.unsplash.com/photo-1526374965328-7f61d4dc18c5?w=400", desc: "Bot otomatisasi tugas rutin." },
            { id: 11, cat: 'design', name: "Logo Premium", price: "500rb", img: "https://images.unsplash.com/photo-1626785774573-4b799315345d?w=400", desc: "Desain logo filosofis 3 konsep." },
            { id: 12, cat: 'design', name: "Social Media Kit", price: "300rb", img: "https://images.unsplash.com/photo-1611162617474-5b21e879e113?w=400", desc: "Template feed & story Instagram." },
            { id: 21, cat: 'license', name: "Windows 11 Pro", price: "150rb", img: "https://images.unsplash.com/photo-1593640408182-31c70c8268f5?w=400", desc: "Lisensi original aktif permanen." },
            { id: 22, cat: 'license', name: "Office 365", price: "200rb", img: "https://images.unsplash.com/photo-1563986768609-322da13575f3?w=400", desc: "Akun resmi durasi 1 tahun." }
        ];

        let selProd = null;

        // --- 4. FUNGSI LOGOUT ---
        function logout() {
            if(confirm("Keluar dari aplikasi?")) {
                localStorage.clear(); // Hapus semua data login
                window.location.href = 'index.html';
            }
        }

        // --- 5. TAMPILKAN PRODUK ---
        function filter(cat) {
            const grid = document.getElementById('productGrid');
            if(!grid) return; // Mencegah error jika elemen belum siap
            
            grid.innerHTML = '';
            const filtered = cat === 'all' ? products : products.filter(p => p.cat === cat);
            
            filtered.forEach(p => {
                grid.innerHTML += `
                <div class="glass p-4 rounded-3xl card-hover flex flex-col h-full">
                    <img src="${p.img}" class="h-32 w-full object-cover rounded-2xl mb-3 bg-slate-800">
                    <h4 class="font-bold text-[12px] text-cyan-400 truncate">${p.name}</h4>
                    <p class="text-[10px] text-slate-400 mt-1 line-clamp-2 flex-grow">${p.desc}</p>
                    <div class="flex justify-between items-center mt-4 pt-3 border-t border-white/5">
                        <span class="text-white font-bold text-[11px]">Rp ${p.price}</span>
                        <button onclick="openModal(${p.id})" class="bg-cyan-500 text-slate-900 px-4 py-1.5 rounded-xl text-[10px] font-bold hover:bg-white transition cursor-pointer">DETAIL</button>
                    </div>
                </div>`;
            });
        }

        // --- 6. INTERAKSI MODAL ---
        function openModal(id) {
            selProd = products.find(p => p.id === id);
            document.getElementById('detailTitle').innerText = selProd.name;
            document.getElementById('detailDesc').innerText = selProd.desc;
            document.getElementById('detailImg').src = selProd.img;
            document.getElementById('detailCat').innerText = selProd.cat;
            document.getElementById('orderNotes').value = ''; 
            document.getElementById('modalOrder').classList.remove('hidden');
        }

        function closeOrderModal() { 
            document.getElementById('modalOrder').classList.add('hidden'); 
        }

        // --- 7. TRANSAKSI DATABASE ---
        function getToken() { return localStorage.getItem('token'); }

        async function confirmPurchase() {
            const notes = document.getElementById('orderNotes').value;
            const qtyInput = document.getElementById('orderQty').value;
            
            if(!notes) return alert("Mohon isi catatan pesanan!");

            // PERBAIKAN: 
            // 1. Hapus field 'date' (biar server yang atur otomatis)
            // 2. Pastikan 'qty' dikirim sebagai Angka (Integer), bukan Teks
            const payload = {
                name: selProd.name,
                notes: notes,
                qty: parseInt(qtyInput), // Ubah teks jadi angka
                time: document.getElementById('orderTime').value
                // date: ... (HAPUS BARIS INI, server akan pakai Date.now otomatis)
            };

            try {
                const res = await fetch(`${API_URL}/orders`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getToken()}`
                    },
                    body: JSON.stringify(payload)
                });

                if(res.ok) {
                    alert("✅ Pesanan Berhasil Disimpan di Server!");
                    closeOrderModal();
                    showPage('assets'); // Pindah ke riwayat
                } else {
                    const data = await res.json();
                    // Tampilkan pesan error asli dari server untuk diagnosa
                    alert("Gagal: " + (data.message || "Data ditolak oleh database"));
                }
            } catch (err) {
                console.error(err);
                alert("Gagal terhubung ke Server! Pastikan 'node server.js' berjalan.");
            }
        }

        async function renderHistory() {
            const list = document.getElementById('orderList');
            list.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-slate-500">Mengambil data dari server...</td></tr>';

            try {
                const res = await fetch(`${API_URL}/orders`, {
                    headers: { 'Authorization': `Bearer ${getToken()}` }
                });
                const data = await res.json();

                if(data.length === 0) {
                    list.innerHTML = '<tr><td colspan="3" class="py-10 text-center text-slate-600 italic">Belum ada pesanan</td></tr>';
                    return;
                }
                
                list.innerHTML = '';
                data.forEach((o) => {
                    list.innerHTML += `
                    <tr class="border-b border-white/5 hover:bg-white/5 transition">
                        <td class="py-4 pl-2">
                            <p class="font-bold text-white text-[11px]">${o.name}</p>
                            <p class="text-[9px] text-slate-500 truncate w-32 md:w-48">${o.notes}</p>
                        </td>
                        <td><span class="text-[9px] bg-cyan-500/10 text-cyan-400 px-2 py-1 rounded-full font-bold uppercase">${o.status}</span></td>
                        <td class="text-right pr-2">
                            <button onclick="deleteRow('${o._id}')" class="text-red-500 text-[10px] font-bold p-2 hover:bg-red-500/10 rounded">HAPUS</button>
                        </td>
                    </tr>`;
                });
            } catch (err) {
                list.innerHTML = '<tr><td colspan="3" class="text-center text-red-500 text-xs py-4">Gagal koneksi ke server.</td></tr>';
            }
        }

        async function deleteRow(id) {
            if(!confirm("Hapus data ini permanen?")) return;
            try {
                const res = await fetch(`${API_URL}/orders/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${getToken()}` }
                });
                if(res.ok) renderHistory();
            } catch (err) { alert("Gagal menghapus"); }
        }

        async function clearAllHistory() {
            if(!confirm("Hapus SEMUA riwayat?")) return;
            try {
                await fetch(`${API_URL}/orders`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${getToken()}` }
                });
                renderHistory();
            } catch (err) { alert("Gagal menghapus"); }
        }

        function showPage(p) {
            document.getElementById('pageStore').classList.toggle('hidden', p !== 'store');
            document.getElementById('pageAssets').classList.toggle('hidden', p !== 'assets');
            
            document.getElementById('tabStore').className = `text-xs font-bold ${p==='store'?'active-tab pb-1':'text-slate-400'}`;
            document.getElementById('tabAssets').className = `text-xs font-bold ${p==='assets'?'active-tab pb-1':'text-slate-400'}`;
            
            if(p === 'assets') renderHistory();
        }

        // --- 8. JALANKAN SAAT LOAD ---
        window.onload = () => {
            filter('all'); // Tampilkan produk saat halaman dibuka
        };
    </script>
</body>
</html>